% Template for PLoS
% Version 1.0 January 2009
%
% To compile to pdf, run:
% latex plos.template
% bibtex plos.template
% latex plos.template
% latex plos.template
% dvipdf plos.template

\documentclass[10pt]{article}

% amsmath package, useful for mathematical formulas
\usepackage{amsmath}
% amssymb package, useful for mathematical symbols
\usepackage{amssymb}

% graphicx package, useful for including eps and pdf graphics
% include graphics with the command \includegraphics
\usepackage{graphicx}

% cite package, to clean up citations in the main text. Do not remove.
\usepackage{cite}

\usepackage{color} 

% Use doublespacing - comment out for single spacing
%\usepackage{setspace} 
%\doublespacing


% Text layout
\topmargin 0.0cm
\oddsidemargin 0.5cm
\evensidemargin 0.5cm
\textwidth 16cm 
\textheight 21cm

% Bold the 'Figure #' in the caption and separate it with a period
% Captions will be left justified
\usepackage[labelfont=bf,labelsep=period,justification=raggedright]{caption}

% Use the PLoS provided bibtex style
\bibliographystyle{plos2009}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother


% Leave date blank
\date{}

\pagestyle{myheadings}
%% ** EDIT HERE **

% FIXME: Remove
\newcommand{\svninfo}{$ $Rev$ $, $ $Date$ $}
\markboth{\svninfo}{\svninfo}

%% ** EDIT HERE **
%% PLEASE INCLUDE ALL MACROS BELOW

%% FIXME: MUST REMOVE BEFORE SUBMITTING TO PLOS
%\usepackage{todo}
\usepackage{color}
\newcommand{\todo}[1]{{\color{red}[#1]}}

%% END MACROS SECTION

\begin{document}

% Title must be 150 characters or less
\begin{flushleft}
{\Large
\textbf{Reconstruction of flattened retinae}
}
% Insert Author names, affiliations and corresponding author email.
\\
David C. Sterratt$^{1,\ast}$, Daniel L. Nedergaard$^{2}$, Ian
D. Thompson$^{2}$
\\
\bf{1} Institute for Adaptive and Neural Computation, School of
Informatics, University of Edinburgh, Edinburgh, Scotland, UK
\\
\bf{2} MRC Centre for Developmental Neurobiology, King's College
London, London, UK
\\
$\ast$ E-mail: david.c.sterratt@ed.ac.uk
\end{flushleft}

% Please keep the abstract between 250 and 300 words
\section*{Abstract}

In the course of studying the function and development of the visual
system, cells in the retina are often labelled; for example, to
determine the distribution of various types of cell in the retina, to
assess the location of retrograde tracer or to measure the
distribution of a guidance molecule.  Following labelling the retina
is dissected and flattened, and the distribution of labels is measured
in the flattened retina.  The dissection requires a number of
incisions to be made and tears in the rim and incisions can
develop. This complicates analysis as some cells that were close
neighbours are now separated by the incisions.

We present a computational method that overcomes this problem by
reconstructing the 3D shape so that the positions of the labels in the
intact retina can be inferred. The input to the algorithm is the line
segments of the flattened retinal outline, with incisions and tears
marked up by an expert. The retinal outline is split into triangular
elements whose positions are then transformed so that they lie on a
partial sphere with the expected dimensions of the intact retina.  The
transformation is adjusted so as to minimise a physically-inspired
deformation energy function.

% change in the dimensions of each triangle from the flattened outline.

The algorithm is able to produce a transformation which is
sufficiently good for visualisation. \todo{More about validation} 

We demonstrate the application of the method in a number of
situations. \todo{More about applications here.}

% Please keep the Author Summary between 150 and 200 words
% Use first person. PLoS ONE authors please skip this step. 
% Author Summary not valid for PLoS ONE submissions.   
\section*{Author Summary}

\section*{Introduction}

There has been extensive study of the function and development of the
retina and the mapping of retinal ganglion cells to target regions
such as the superior colliculus or lateral geniculate nucleus. In this
field a common experimental procedure is to label cells in the retina
\emph{in vivo} and then dissect and flatten the retina to produce a
flat-mount in which the distribution of labels can be measured. In
order to flatten the retina, a number of incisions have to be made,
and tearing can occur within the rim of the retina or the incisions.
Flat-mounted retinae have been used in a variety of
applications. However their use does have problems.

For example, the distribution of mosaics of various cell types has
been recorded in flat-mounted retinae
\cite{WassBoyc91func,RaveEtal03dete}.  Nearest neighbour analyses are
often used to quantify the regularity of mosaics, but these are
susceptible to the existence of boundaries \cite{Cook96spat}, both at
the rim of the retina and those introduced by the incision required
during dissection. These extra boundaries reduce the effective number
of cells that can be analysed, which could be significant in low
density mosaics.

In the study of topographic mapping, the locations of retrograde
tracers injected in the superior colliculus have been measured in
retinal flat mounts \cite{RebeEtal04rela,RashEtal05oppo}. The
distribution of tracer can be split across incisions and tears,
complicating nearest-neighbour analyses and in some cases making it
impossible to determine a mean location that lies within the outline
of the flattened retina.

To understand the mechanisms underlying topographic mapping, retinal
flat-mounts labelled with markers for the EphA receptor
\cite{ChenEtal95comp} have been produced. The principal axis of
variation in the flat mount appears to be the naso-temporal axis.
Flat-mounts stained for EphB receptors have also been produced
\cite{BirgEtal00kina} and here the principal axis is appears to be the
dorso-ventral axis. In both cases, the pixel intensity has been
quantified along the principal axis but not throughout the rest of the
retina.  Together with the finding that the mapping from a flat screen
to the superior colliculus is approximately Cartesian
\cite{DragHube76topo} this apparent alignment of EphA and EphB
gradients along the naso-temporal and dorso-ventral axes of the retina
has led to the mapping from the retina to the colliculus being
described as Cartesian \cite{BeviEtal11gene}. However, this cannot be
the case as the surface of the intact retina is by no means a
Cartesian surface, which can be described using rectilinear
coordinates.  Rather it needs to be described using curvilinear
coordinates. Being able to describe the density of marker as a
function of location in the intact retina would force a deeper
understanding of how the mapping process occurs.

% The locations of the labels are measured in the two-dimensional
% Euclidean space defined by the slide, but this coordinate system is
% not entirely satisfactory for at least two reasons. Firstly, the
% incisions and tears may splits clusters of labelled cells which were
% centred around the same point in the intact retina. The mean location
% of such a split cluster in the Euclidean plane may lie outside the
% retinal outline. Secondly, it is difficult to infer the location with
% respect to the retinal pole and the nasal, temporal, ventral and
% dorsal poles with any degree of accuracy.

The aim of the method presented in this paper is to infer the
coordinates in intact retinal space of points on a flattened
retina. The retina is approximated as a partial sphere, and the
coordinate system can be thought of as lines of latitude and longitude
on the globe.  The method requires that an expert mark up the cuts and
tears, and also that they indicate the position of at least one
landmark on the rim of the eye. The method has been implemented as a
program written in R, and can reconstruct a retina within a few
minutes on a desktop machine. The accuracy of the method is estimated
to be \todo{produce estimate for accuracy of method}.

It would be possible to generalise the method to deal with a retina
modelled by any shape with axial symmetry.

% The algorithm is able to produce a transformation which is
% sufficiently good for visualisation. \todo{More about validation} 

We demonstrate the application of the method in a number of
situations. \todo{More about applications here.}


% Results and Discussion can be combined.
\section*{Results}

\subsection*{The reconstruction algorithm}

The reconstruction algorithm is illustrated in
Figure~\ref{fold-sphere:fig:method} and we present a more detailed
description in the Methods. In brief, the starting point of the
algorithm is the retinal outline
(Figure~\ref{fold-sphere:fig:method}A), in this example with some
labelled points (red, green and yellow circles) and an example of a
landmark (blue line), in this case the optic disk.  The first step is
for an expert to mark the locations of incisions and tears in the
outline and to mark the location of one of the poles
(Figure~\ref{fold-sphere:fig:method}B). The algorithm then
triangulates the outline and stitches together the incisions and tears
(Figure~\ref{fold-sphere:fig:method}C). This mesh is then projected
onto a spherical surface, with the points on the rim all lying at the
same latitude (Figure~\ref{fold-sphere:fig:method}Di). Each edge in
the mesh is treated as a spring whose natural length is the length of
the corresponding edge in the flat mesh.  In the initial mapping onto
the spherical surface, the springs are compressed or expanded; in the
next step the springs are allowed to relax so as to minimise the total
potential energy contained in all the springs. This gives the
spherical mesh shown in
Figure~\ref{fold-sphere:fig:method}Ei. Finally, the locations of data
points and landmarks in the flat retina can be projected onto the
reconstructed retina, which can be represented using a polar plot
(Figure~\ref{fold-sphere:fig:method}Fi). The mean locations of groups
of data points on the sphere is computed using the Karcher mean (see
Methods).

An alternative representation is shown in
Figures~\ref{fold-sphere:fig:method}Dii, Eii and Fii, where lines of
latitude and longitude on the spherical retina have been projected
onto the flat structure. In particular the jump between Dii and Eii
illustrates the improvement in the appearance of the mapping achieved
using the energy minimisation.

To assess the amount of residual deformation at the end of the energy
minimisation procedure, we plotted the length of the edge in the
spherical mesh versus the length of the edge in the flat mesh
(Figure~\ref{retistruct_plos:fig:examples}Ai). We visualised the
deformation by representing the log strain as coloured edge in the
flat mesh (Figure~\ref{retistruct_plos:fig:examples}Aii). The log
strain is defined as $\ln(l/L)$ where $l$ is the length of the edge in
the spherical representation and $L$ is the length of the edge in the
flat representation. For a spring at its natural length it is zero
(represented by green), for a compressed spring it is negative (blue)
and for an expanded one positive (red).

A measure of the overall goodness of reconstruction is the square root
of the length energy function:
\begin{equation} 
  \sqrt{E_\mathrm{L}} = \sqrt{\frac{1}{2|\mathcal{C}|\overline{L}}
  \sum_{i\in\mathcal{C}} \frac{(l_i - L_i)^2}{L_i}}
\end{equation} 
where $L_i$ is the length of the $i$th edge in the flat mesh, $l_i$
the length of the corresponding edge in the spherical mesh, and the
summation is over, $\mathcal{C}$, the set of edges. The mean length of
an edge in the flat mesh is $\overline{L}$ and the number of edges is
$|\mathcal{C}|$. This measure is constructed so as to be of a similar
order to the mean log strain, which in turn is of the same order as
the mean fractional deformation.  We used our algorithm to reconstruct
226 retina. The distribution of the goodness measure is shown in
Figure~\ref{retistruct_plos:fig:summary}. It can be seen that there
are a number of outliers for which reconstruction failed totally and
then a log-normal
distribution. Figure~\ref{retistruct_plos:fig:examples}A shows an
example of a good reconstruction with an energy measure
$\sqrt{E_\mathrm{L}}=0.039$ and
Figure~\ref{retistruct_plos:fig:examples}B an example of a bad one
with $\sqrt{E_\mathrm{L}}=0.278$.
\todo{Note that I am currently playing with the parameters of the
  algorithm having made a subtle change to the error measure, so I
  think there is some room for improvement.}

\subsection*{Validation of the reconstruction algorithm}

\todo{Comparison of MRI images and reconstructed retinae.}

\subsection*{Application: retrograde tracing}

\todo{Need to discuss this with Dan and Ian}

\subsection*{Application: mosaic properties?}

\todo{Could discuss this with Stephen}

\subsection*{Application: marker distribution in spherical coordinates}

\todo{This would need some decent flat-mount images of EphA or EphB
  and some more work.}

\section*{Discussion}

\todo{This is all at brain dump stage.}

\subsection*{Insights gained from the method}

\todo{What we have learnt by using the method}

\subsection*{Accuracy of the method}

\subsection*{Validity of the physical model}

As far as we are aware, a computational algorithm for reconstructing
retinae has never been described
before.\footnote{\todo{DW: But what about optometry?}} The algorithm
presented here models the retinal tissue as a mesh of masses connected
by springs. This basic model is used in modelling deformable surfaces
in computer animation and clothes design
\cite{FanEtal98spri,MaCaEtal99flat,WangEtal02surf} and has been used
in models of tissue \todo{REF}.  This model should ensure that
neighbourhood relations are preserved -- nodes close in the 2D
structure should still be close in the 3D structure -- and
incorporates the notion of an elastic material. However, it does not
incorporate an explicitly representation of tensile and shear forces.

A more physically-principled method of modelling deformation of
objects is offered by the finite element method (FEM), in which the
stress and strain of each triangular element in the mesh is derived as
a function of the deformation of the points of the element
\cite{ZienTayl00fini}. The stress and strain matrices represent
shearing with in the material and materials with varying degrees of
compressibility (as quantified by Poisson's ratio) can be modelled.
The FEM is used widely to describe properties of soft tissue in
simulations of surgery \cite{CartEtal05appl}. The soft tissue is often
described as a linear-elastic medium, in which the stress depends
linearly of the strain, but it can also be modelled as a viscoelastic
medium, in which the stress depends on the history of the strain in
the material.

% the finite element method is based more strongly on the physics of
% materials and is regarded as superior \cite{CartEtal05appl}.

In principle the FEM allows parameters of the material to be measured
and incorporated in the model in a straightforward way. Given enough
data about the material properties of retinal tissue, the model could
be more realistic that the spring-mass model used here.  Weighed
against this, is the fact that it is not possible to apply the finite
element method simply to the problem of mapping the flattened retina
onto the intact retina, as this would require knowledge of the
stresses and strains in the flattened retina, whereas the only
information available is the outline of the retina and the location of
the optic disk. Also, the standard FEM does not allow for the rotation
of elements, only their translation or expansion and shearing.

Nevertheless, it would be possible to use a modified version of the
FEM, along with data (or assumptions) about the material properties of
retinal tissue to model directly the action of the retinal being
flattened following the dissection cuts. This would lead to a
prediction of how a retina cut in a particular set of loci would look
when flattened. Unfortunately, we do not have precise knowledge of
where the cuts were made in the intact retina or how tears developed,
so some sort of complex iterative approach would have to be taken.

% However, the problem of mapping between 2D and 3D surfaces appears in
% other situations, such as in clothes design and computer animation
% . Workers in this field have taken a similar approach to the one taken
% here and their work has informed the algorithm presented here.
% % Surfaces are
% % triangulated and the edges in the triangulation are treated as springs
% % within the elastic limit.
% The basic physical model of the material as a mesh of masses connected
% by springs. 

% 3D surfaces are mapped to 2D surfaces by first triangulating the 3D
% surface, then projecting the points to the 2D plane, and then moving
% the locations of nodes of the triangulation on the plane so as to
% minimise an energy function based on the differences between the
% lengths of edges in the 3D configuration and in the 2D
% configuration. A penalty term to the error function can be added to
% prevent nodes crossing over edges \cite{WangEtal02surf}. In the
% mapping from 2D surface to 3D surfaces, the effects of forces due to
% sewing together edges of cloth and of gravity may be incorporated
% \cite{FanEtal98spri}.




% \subsection*{Potential problems with the method}
% \label{fold-sphere:sec:appr-simil-probl}

% The bulk viscoelastic properties of bovine retinal tissue have been
% measured.  The Young's modulus of rabbit retina in varying stages of
% development, under the assumption that the retina had linear
% elasticity and a Poission ratio of 0.5 \cite{ReicEtal91deve}.  The
% Poission's ratio is an index of how much a material shrinks in the two
% dimentions perpendicular to an expansion. A perfectly incopressible
% matierial has an Poission's ratio of 0.5. They found that the modulus
% increased threefold between P2 and P15. They also found that the
% stiffness of the retinal tissue depended on its location within the
% retina. The centre of the retina was stiffer than the periphery. This
% was due to the thickness of the tissue, which was greater in the
% centre than in the periphery.  The elastic properties of bovine
% retinal tissue dominate over the viscous properties, and that the
% material has a Poisson's ratio of around 0.45 \cite{LuEtal06visc}.

% \subsection*{Alternative methods}
% \label{fold-sphere:sec:alternative-methods}

% In the process of developing the solution presented in this paper, a
% number of options were evaluated:

% \paragraph{Forward or backward model:} 


% It is conceivable that the result of a forward model could be compared
% to the flattened outline in question, and the difference between the
% two used to modify the locations of tears and cuts on the intact model
% retina and that this procedure could be iterated until the patterns of
% cuts and tears on the intact retina converged.

% However, because it is highly likely that the model is a
% simplification of material properties of the real retina, it would be
% very unlikely that the outline of flattened model retinal would match
% the actual flattened retina, and we would be left with the problem of
% how to match up the edges of the actual and model flattened
% retinae. It is also difficult to envision an algorithm for inferring
% the locations of the tears and cuts that would be efficient. For these
% reasons, we rejected an iterative forward-backward modelling approach
% in which the tear locations on the intact retina were inferred.

% In the simple backward approach undertaken in this paper, the stresses
% and strains in the flattened retina are all assumed to be zero. In the
% mapping onto the intact retina, the elements of the mesh become
% strained. This is clearly unphysical, but may be a reasonable
% approximation to the actual Physics because:
% \begin{enumerate}
% \item For small stresses and strains, if the nodes are mapped back
%   onto the flattened retina, the locations shouldn't change much
%   (evidence?).
% \end{enumerate}

% \paragraph{Finite element versus spring-mass}
% \label{fold-sphere:sec:finite-elem-vers}


% Nevertheless, it would be possible to attempt to try applying the
% finite element, initialised with unstressed elements, to the backward
% transformation. This would give an estimate of the positions of the
% locations of nodes on the intact retina. These nodal positions could
% then be used to estimate the stiffness matrix for each element,
% assuming that each element was unstressed on the intact retina. The
% deformation of this structure when flattened could then be estimated
% by fixing the locations around the rim and edges, and solving for the
% unknown positions. This would lead to each element being strained, and
% these strains could then be used to initialise a second mapping back
% on to the intact retina, which would hopefully give rise to a more
% accurate estimation of the nodal positions. 

% This method would have the advantages of greater physical plausibility,
% and would afford the opportunity to incorporate elastic properties
% which vary with distance from the centre of the retina. However, this
% would come at the cost of some increase in complexity.

% You may title this section "Methods" or "Models". 
% "Models" is not a valid title for PLoS ONE authors. However, PLoS ONE
% authors may use "Analysis" 
\section*{Materials and Methods}
\label{retistruct_plos:sec:materials-methods}

\subsection*{Retinae}
\label{retistruct_plos:sec:retinae}

\todo{Some information about the preparation of the retinae.}

\subsection*{Reconstruction algorithm}
\label{retistruct_plos:sec:reconstr-algor}

The reconstruction algorithm described here has been implemented in R
(http://www.r-project.org) and can be downloaded as an R package from
http://www.neuralmapformation.org/code/retistruct. It has been tested
under a GNU/Linux platform but should also work in MacOS or Windows
environments.

The steps of the reconstruction algorithm are illustrated in
Figure~\ref{fold-sphere:fig:method}. The raw data
(Figure~\ref{fold-sphere:fig:method}A) consists of the sequence of
points making up the outline, sets of data points and sequences of
connected points defining landmarks, such as the optic disk. The
reconstruction process then proceeds as follows:
\begin{enumerate}
\item The location of one of the poles and all the incisions and tears
  in the outline are marked up by an expert
  (Figure~\ref{fold-sphere:fig:method}B). Each tear is defined by a
  central point, referred to as the apex, and two outer points,
  referred to as vertices.  Tears within tears or incisions (for
  example tear 2 in Figure~\ref{fold-sphere:fig:method}B) can be
  marked up. The Retistruct package contains a graphical user
  interface to allow incisions and tears to be marked up quickly.
\item The retinal outline is triangulated using the conforming
  Delaunay triangulation algorithm provided by the Triangle package
  \cite{Shew96tria} such that there are at least 500 triangles in
  the outline (grey lines in Figure~\ref{fold-sphere:fig:method}C).
\item The tears and incisions are stitched automatically (blue and
  green lines in Figure~\ref{fold-sphere:fig:method}D). To do this,
  the length of each side of every tear is computed. The fractional
  distance of each point in each tear is then defined as the distance
  along the tear of that point from the apex divided by the total
  length of that side of the tear. For each point on one side of a
  tear a point is inserted at the same fractional distance along the
  opposing side. Tears within tears are dealt with by excluding the
  child tear when computing the fractional distance. At the end of the
  procedure there is a set of correspondences between two or, in the
  case of the vertices of a child tear, three points.
\item There is then an extra round of triangulation to incorporate the
  points that have been inserted into incisions and tears.
\item The points within each set of correspondences are merged and
  allocated positions on the 2D surface.
\item The triangulation points are then projected onto a sphere
  curtailed at latitude of $\phi_0$
  (Figure~\ref{fold-sphere:fig:method}D). The latitude is estimated on
  the basis of measurements from intact retinae of animals of the same
  age as the retina under reconstruction. The radius $R$ of the sphere
  is determined by the area of the flattened retina and $\phi_0$.
  Points on the rim of flattened retina are fixed to the rim of the
  curtailed sphere.
\item The optimal projection onto sphere
  (Figure~\ref{fold-sphere:fig:method}E) is inferred by shifting the
  locations of the vertices on the spherical surface so as to minimise
  an error measure. This measure, $E$, comprises the sum of normalised
  squared differences between lengths of corresponding connections in
  flattened and spherical retina and a penalty term that prevents the
  triangles from flipping over:
  \begin{equation}
    E = \frac{1}{2|\mathcal{C}|\overline{L}} \sum_{i\in\mathcal{C}} \frac{(l_i - L_i)^2}{L_i}  
    + \alpha\sum_{j\in\mathcal{T}} f(a_j/A_j)
  \end{equation}
  where $L_i$ and $l_i$ are lengths of corresponding edges
  $i\in\mathcal{C}$ in the flattened and spherical retina
  respectively, $\overline{L}$ is the mean length of an edge,
  $|\mathcal{C}|$ is the number of edges, $\alpha$ is a constant, $f$
  is a penalty function to be defined below, and $A_j$ and $a_j$ are
  signed areas of corresponding triangles $j\in\mathcal{T}$ in the
  flattened and spherical retina.  The signed area $a_i$ is positive
  for triangles in correct orientation, but negative for flipped
  triangles. The penalty function $f$ is a piecewise, smooth function
  that increases steeply with negative arguments:
  \begin{equation}
    \label{retistruct_plos:eq:1}
    f(x) = \left\{
        \begin{array}{ll}
          -(x - x_0/2) & x < 0 \\
          \frac{1}{2x_0}(x - x_0)^2 & 0 < x <x_0 \\
          0 & x \ge x_0
          \end{array} \right.
  \end{equation}
  The parameter $x_0$ is set at 0.1. There is thus no penalty unless
  triangles have been squashed to less than 10\% of their size in the
  flattened retina.  The parameter $\alpha$ is set to be large enough
  to prevent flipped triangles without causing numerical problems with
  the optimisation. The length of each edge $l_i$ is computed from the
  formula for the central angle between its vertices:
  \begin{equation}
    \label{retistruct_plos:eq:2}
    l(\phi_1, \lambda_1, \phi_2, \lambda_2) =
    R(\cos\phi_1\cos\phi_2\cos(\lambda_1-\lambda_2) +
    \sin\phi_1\sin\phi_2)
  \end{equation}
  where $\phi_1$ and $\phi_2$ are the latitudes of the vertices and
  $\lambda_1$ and $\lambda_2$ are the longitudes.  The derivatives of
  $E$ with respect to $\phi_i$ and $\lambda_i$ are computed and the
  BFGS quasi-Newton method implemented in the R optim function is used
  to minimise $E$.
\item The locations of data points and landmarks on the sphere are
  determined (Figure~\ref{fold-sphere:fig:method}F). To do this, for
  each data point the barycentric coordinates within its containing
  triangle in the flat representation are determined.  The location of
  the point on the sphere is then found by projecting the point to the
  same set of barycentric coordinates in the corresponding triangle on
  the sphere. From this location in Cartesian 3D space, the spherical
  coordinates of the point are determined by projection of a line from
  the centre of the sphere through the point to the line's
  intersection with the sphere. This allows plotting of points in a
  polar representation. The procedure can be used in reverse to infer
  the locations of lines of latitude and longitude in the flat retina.
\item The Karcher mean of each set of points is determined
  (Figure~\ref{fold-sphere:fig:method}F). The Karcher mean of a set of
  points on the sphere \cite{Karc77riem,HeoSmal06form} is defined as
  the point $(\overline{\phi}, \overline{\lambda})$ that has a minimal
  sum of squared distances to the set of points $(\phi_i, \lambda_i)$:
  %% See also BergWerm06
  \begin{equation}
    \label{retistruct_plos:eq:3}
    (\overline{\phi}, \overline{\lambda}) = \mbox{arg min}_{(\phi,
      \lambda)} \sum_{i=1}^N l^2(\phi, \lambda, \phi_i, \lambda_i)
  \end{equation}
  where the function $l$ is defined in
  Equation~(\ref{retistruct_plos:eq:2}).
\end{enumerate}

The procedure of reconstructing a retina takes a few minutes on a
modern desktop computer.

% Do NOT remove this, even if you are not including acknowledgments
\section*{Acknowledgments}

David Willshaw, Stephen Eglen and Michael Herrmann.

%\section*{References}
% The bibtex filename
\newcommand{\myshortjournaltitles}{}
\bibliography{nmf_morph}
%\bibliography{template}

\section*{Figure Legends}
%\begin{figure}[!ht]
%\begin{center}
%%\includegraphics[width=4in]{figure_name.2.eps}
%\end{center}
%\caption{
%{\bf Bold the first sentence.}  Rest of figure 2  caption.  Caption 
%should be left justified, as specified by the options to the caption 
%package.
%}
%\label{Figure_label}
%\end{figure}

\begin{figure}[!ht]
  % Example. e.g. GM114-4/R-CONTRA (One subtear + gap)
  % GM184-5/R-CONTRA (One subtear, butter gap)
  % GM263-1/R-CONTRA (perfect!)
  \includegraphics{retistruct-method}
  
  \vspace*{-4.54in}

  \mbox{\hspace{2.27in}{
      \includegraphics[width=2.27in]{final-projection}
      \includegraphics[width=2.27in]{initial-projection}
    }}

  \vspace*{2.27in}

  \caption{\textbf{Overview of the method.} \textbf{(A)} The raw data:
    a retinal outline (black), three types of data point (red, green
    and yellow circles) and a landmark (blue line). \textbf{(B)}
    Retinal outline with nasal pole (N) and tears marked up. Each pair
    of red and orange lines indicate the vertices and apex of the five
    tears. Note that tear 2 is a child tear of tear 1. \textbf{(C)}
    The outline after triangulation (shown by grey lines) and
    stitching, indicated by blue lines between corresponding points on
    the tears. Green lines indicate connections between tear vertices.
    \textbf{(D)} The initial projection of the triangulated and
    stitched outline onto a hemisphere. Tears are show in white. Below
    is a representation of lines of latitude and longitude on the flat
    outline. \textbf{(E)} The projection of the flat retina onto the
    sphere and the lines of latitude and longitude after optimisation
    of the mapping. \textbf{(F)} The data represented on a polar plot
    of the reconstructed retina. Mean locations of the different types
    of data points are indicated by filled diamonds. The nasal (N),
    dorsal (D), temporal (T) and ventral (V) poles are indicated. For
    reference, data is plotted on the flat representation
    below.
    \todo{Figures under D, E and F need to be grouped. The spherical
      representation should be as an open mesh, i.e. grey edges, white
      surfaces and the cuts in orange or red. Arrows from
      A$\rightarrow$B$\rightarrow$C$\rightarrow$D$\rightarrow$E$\rightarrow$F
      would indicate the progression.}}
  \label{fold-sphere:fig:method}
\end{figure}

\begin{figure}[!ht]
  \centering
  \begin{tabular}{llll}
    Ai & Aii & Bi & Bii  \\
  \includegraphics[width=0.24\linewidth]{C57BL6J_P2_AP_GM367-7_R-CONTRA-strain-lvsL}
  &
  \includegraphics[width=0.24\linewidth]{C57BL6J_P2_AP_GM367-7_R-CONTRA-strain}
  &
  \includegraphics[width=0.24\linewidth]{C57BL6J_adult_single_GM251_R-CONTRA-strain-lvsL}
  &
  \includegraphics[width=0.24\linewidth]{C57BL6J_adult_single_GM251_R-CONTRA-strain}
  \\
  Aiii & Aiv & Biii & Biv  \\
  \includegraphics[width=0.24\linewidth]{C57BL6J_P2_AP_GM367-7_R-CONTRA-flat}
  &
  \includegraphics[width=0.24\linewidth]{C57BL6J_P2_AP_GM367-7_R-CONTRA-polar}
  &
  \includegraphics[width=0.24\linewidth]{C57BL6J_adult_single_GM251_R-CONTRA-flat}
  &
  \includegraphics[width=0.24\linewidth]{C57BL6J_adult_single_GM251_R-CONTRA-polar}
  \end{tabular}

  \caption{\textbf{Examples of reconstructed retinae.} \textbf{(A)}~An
    example of a good reconstruction.  \textbf{(Ai)}~Plot of length of
    edge on the sphere versus length of edge on the flat retina. Red
    indicates an edge that has expanded and blue a link that has been
    compressed.  \textbf{(Aii)}~The log strain indicated using the
    same colour scheme on the flat retina. \textbf{(Aiii)}~The flat
    representation of lines of latitude and longitude with data
    points. \textbf{(Aiv)}~The polar representation with data
    points. \textbf{(B)}~An example of a bad reconstruction. Meaning of
    \textbf{(Bi--iv)} same as for \textbf{(A)}. \todo{These figures are
    not necessarily the final ones. Labels need to be increased in
    size. Hopefully the bad retina will get better -- I am
    experimenting with values of $\alpha$ and $x_0$.}.
  }
  \label{retistruct_plos:fig:examples}
\end{figure}

\begin{figure}[!ht]
  \centering
  \includegraphics{summ16}
  \caption{\textbf{Histogram of reconstruction errors.}  Successful
    reconstructions of 226 retinae were made and the energy
    recorded. The energy at the end of each reconstruction was
    recorded and the histogram of the square root of this energy is
    displayed here. For lower values the value of
    $\sqrt{E_\mathrm{L}}$ is similar to the mean percentage
    deformation.}
  \label{retistruct_plos:fig:summary}
\end{figure}

\section*{Tables}
%\begin{table}[!ht]
%\caption{
%\bf{Table title}}
%\begin{tabular}{|c|c|c|}
%table information
%\end{tabular}
%\begin{flushleft}Table caption
%\end{flushleft}
%\label{tab:label}
% \end{table}

\end{document}


% LocalWords:  Sterratt Nedergaard MRC MacOS Retistruct BFGS optim Karcher arg
% LocalWords:  Acknowledgments nmf naso EphB dorso Ei Fi Dii Eii Fii Ai Aii DW
% LocalWords:  Willshaw Eglen Herrmann llll Bii Aiii Aiv Biii Biv th
