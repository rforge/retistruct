% Template for PLoS
% Version 1.0 January 2009
%
% To compile to pdf, run:
% latex plos.template
% bibtex plos.template
% latex plos.template
% latex plos.template
% dvipdf plos.template

\documentclass[10pt]{article}

% amsmath package, useful for mathematical formulas
\usepackage{amsmath}
% amssymb package, useful for mathematical symbols
\usepackage{amssymb}

% graphicx package, useful for including eps and pdf graphics
% include graphics with the command \includegraphics
\usepackage{graphicx}

% cite package, to clean up citations in the main text. Do not remove.
\usepackage{cite}

\usepackage{color} 

% Use doublespacing - comment out for single spacing
%\usepackage{setspace} 
%\doublespacing


% Text layout
\topmargin 0.0cm
\oddsidemargin 0.5cm
\evensidemargin 0.5cm
\textwidth 16cm 
\textheight 21cm

% Bold the 'Figure #' in the caption and separate it with a period
% Captions will be left justified
\usepackage[labelfont=bf,labelsep=period,justification=raggedright]{caption}

% Use the PLoS provided bibtex style
\bibliographystyle{plos2009}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother


% Leave date blank
\date{}

\pagestyle{myheadings}
%% ** EDIT HERE **


%% ** EDIT HERE **
%% PLEASE INCLUDE ALL MACROS BELOW

%% FIXME: MUST REMOVE BEFORE SUBMITTING TO PLOS
\usepackage{todo}

%% END MACROS SECTION

\begin{document}

% Title must be 150 characters or less
\begin{flushleft}
{\Large
\textbf{Reconstruction of flattened retinae}
}
% Insert Author names, affiliations and corresponding author email.
\\
David C. Sterratt$^{1,\ast}$, Daniel L. Nedergaard$^{2}$, Ian
D. Thompson$^{2}$
\\
\bf{1} Institute for Adaptive and Neural Computation, School of
Informatics, University of Edinburgh, Edinburgh, Scotland, UK
\\
\bf{2} MRC Centre for Developmental Neurobiology, King's College
London, London, UK
\\
$\ast$ E-mail: david.c.sterratt@ed.ac.uk
\end{flushleft}

% Please keep the abstract between 250 and 300 words
\section*{Abstract}

% In retrograde tracing experiments to determine the mapping of
%   connections from the retina to the superior colliculus in mice, a
%   small blob of dye is injected in the superior colliculus and allowed
%   to diffuse retrogradely down the axons of retinal ganglion cells to
%   their cell bodies in the retina. 

In the course of studying the function and development of the visual
system cells in the retina are often labelled, for example to
determine the distribution of particular categories of cell in the
retina, to assess the location of retrograde tracer or to measure the
distribution of a guidance molecule.  Following labelling the retina
is dissected and flattened, and the distribution of labels is measured
in the flattened retina.  In the process of flattening the retina, a
number incisions are made, complicating analysis as some cells that
were close neighbours are now separated by the incisions.  

We present a computational method that overcomes this problem by
inferring where the labels were in the intact retina before
flattening. The input to the algorithm is the line segments of the
flattened retinal outline with incisions and tears marked up by an
expert. The retinal outline is split into triangular elements whose
positions are then transformed so that they lie on a partial sphere
with the expected dimensions of the intact retina.  The transformation
is adjusted so as to minimise the change in the dimensions of each
triangle from the flattened outline.

The algorithm is able to produce a transformation which is
sufficiently good for visualisation. \todo{More about validation} 

We demonstrate the application of the method in a number of
situations. \todo{More about applications here.}

% Please keep the Author Summary between 150 and 200 words
% Use first person. PLoS ONE authors please skip this step. 
% Author Summary not valid for PLoS ONE submissions.   
\section*{Author Summary}

\section*{Introduction}

The function and development of the retina and the mapping of retinal
ganglion cells has been studied extensively in recent years. In this
field a common experimental procedure is to label cells in the retina
\emph{in vivo} and then dissect and flatten the retina to produce a
whole-mount in which the distribution of labels can be measured. In
order to flatten the retina, a number incisions have to be made, and
tearing can occur within the rim of the retina or the incisions.

Labelled retinal whole-mounts have been used to determine the
distribution of mosaics of particular categories of cell in the
retina \cite{WassBoyc91func,RaveEtal03dete}.  Nearest neighbour
analyses are often used to quantify the regularity of mosaics, but
these are susceptible to boundaries \cite{Cook96spat}, both of the rim
of the retina and those introduced by the incision required during
dissection. These extra boundaries reduce the effective number of
cells that can be analysed, which could be significant in low density
mosaics. 

In the study of topographic mapping, the locations of retrograde
tracers injected in the superior colliculus have been measured in
retinal whole mounts \cite{RebeEtal04rela,RashEtal05oppo}. The
distribution of tracer can be split across incisions and tears,
complicating nearest-neighbour analyses and in some cases making it
impossible to determine a mean location that lies with in the outline
of the flattened retina.

Also in the field of topographic mapping, retinal whole-mounts
labelled with markers for the EphA receptor \cite{ChenEtal95comp} have
been produced. The principal axis of variation in the flat mount
appears to be the naso-temporal axis.  Whole-mounts stained for EphB
receptors have also been produced \cite{BirgEtal00kina} and here the
principal axis is appears to be the dorso-ventral axis. In both cases,
the pixel intensity has been quantified along along the apparent
principal axis but not throughout the rest of the retina.  Together
with the finding that the mapping from a flat screen to the superior
colliculus is approximately Cartesian \cite{DragHube76topo} this
apparent alignment of EphA and EphB gradients along the naso-temporal
and dorso-ventral axes of the retina has lead to the mapping from the
retina to the colliculus being described as Cartesian
\cite{BeviEtal11gene}. However, this cannot be the case as the surface
of the intact retina is by no means a Cartesian surface that can be
described using rectilinear coordinates.  Rather it needs to be
described using curvilinear coordinates. Being able to describe the
density of marker as a function of location in the intact retina would
force a deeper understanding of how the mapping process occurs.

% The locations of the labels are measured in the two-dimensional
% Euclidean space defined by the slide, but this coordinate system is
% not entirely satisfactory for at least two reasons. Firstly, the
% incisions and tears may splits clusters of labelled cells which were
% centred around the same point in the intact retina. The mean location
% of such a split cluster in the Euclidean plane may lie outside the
% retinal outline. Secondly, it is difficult to infer the location with
% respect to the retinal pole and the nasal, temporal, ventral and
% dorsal poles with any degree of accuracy.

Therefore the aim of the method presented in this paper is to infer
the coordinates in intact retinal space of points on a flattened
retina. At present, the retina is approximated as a partial sphere,
and the coordinate system can be thought of as lines of latitude and
longitude on the globe. However, it would be possible to generalise
the method to deal with a retina modelled by any shape with axial
symmetry. The method requires that an expert mark up the cuts and
tears, and also that they indicate the position of at least one
landmark on the rim of the eye. The method has been implemented as a
program written in R, and can reconstruct a retina within a few
minutes on a desktop machine. The accuracy of the method is estimated
to be \todo{produce estimate for accuracy of method}.

% The algorithm is able to produce a transformation which is
% sufficiently good for visualisation. \todo{More about validation} 

We demonstrate the application of the method in a number of
situations. \todo{More about applications here.}


% Results and Discussion can be combined.
\section*{Results}

\subsection*{Subsection 1}

\subsection*{Subsection 2}

\section*{Discussion}

% You may title this section "Methods" or "Models". 
% "Models" is not a valid title for PLoS ONE authors. However, PLoS ONE
% authors may use "Analysis" 
\section*{Materials and Methods}
\label{retistruct_plos:sec:materials-methods}

\subsection*{Retinae}
\label{retistruct_plos:sec:retinae}

\todo{Some information about the preparation of the retinae.}

\subsection*{Reconstruction algorithm}
\label{retistruct_plos:sec:reconstr-algor}

The reconstruction algorithm described here has been implemented in R
(http://www.r-project.org) and can be downloaded as an R package from
http://www.neuralmapformation.org/code/retistruct. It has been tested
under a GNU/Linux platform but should also work in MacOS or Windows
environments.

The steps of the reconstruction algorithm are illustrated in
Figure~\ref{fold-sphere:fig:method}. The raw data
(Figure~\ref{fold-sphere:fig:method}A) consists of the sequence of
points making up the outline, sets of data points and sequences of
connected points defining landmarks, such as the optic disk. The
reconstruction process then proceeds as follows:
\begin{enumerate}
\item The location of one of the poles and incisions and tears in the
  outline are marked up by an expert
  (Figure~\ref{fold-sphere:fig:method}B). Each tear is defined by a
  central point, referred to as the apex, and two outer points,
  referred to as vertices.  Tears within tears or incisions (for
  example tear 2 in Figure~\ref{fold-sphere:fig:method}B) can be
  marked up. The Retistruct package contains a graphical user
  interface to allow incisions and tears to be marked up quickly.
\item The retinal outline is triangulated using the conforming
  Delaunay triangulation algorithm provided by the Triangle package
  \cite{Shew96tria} such that there are at least 500 triangles in
  the outline (grey lines in Figure~\ref{fold-sphere:fig:method}C).
\item The tears and incisions are stitched automatically (blue and
  green lines in Figure~\ref{fold-sphere:fig:method}D). To do this,
  the length of each side of every tear is computed. The fractional
  distance of each point in each tear is then defined as the distance
  along the tear of that point from the apex divided by the total
  length of that side of the tear. For each point on one side of a
  tear a point is inserted at the same fractional distance along the
  opposing side. Tears within tears are dealt with by excluding the
  child tear when computing the fractional distance. At the end of the
  procedure there is a set of correspondences between two or, in the
  case of the vertices of a child tear, three points.
\item There is then an extra round of triangulation to incorporate the
  points that have been inserted into incisions and tears.
\item The points within each set of correspondences are merged and
  allocated positions on the 2D surface.
\item The triangulation points are then projected roughly onto a
  sphere curtailed at latitude of $\phi_0$
  (Figure~\ref{fold-sphere:fig:method}D). The latitude is estimated
  on the basis of measurements from intact retinae of animals of the
 same age as the retina under reconstruction. The radius $R$ of the
  sphere determined by area of the flattened retina and $\phi_0$.
  Points on the rim of flattened retina are fixed to the rim of the
  curtailed sphere. 
\item The optimal projection onto sphere
  (Figure~\ref{fold-sphere:fig:method}E) is inferred by changing
  location of vertices on sphere so as to minimise an error
  measure. This measure, $E$, comprises the sum of normalised squared
  differences between lengths of corresponding connections in
  flattened and spherical retina and a penalty term that prevents the
  triangles from flipping over:
  \begin{equation}
    E = \frac{1}{2} \sum_{i\in\mathcal{C}} \frac{(l_i - L_i)^2}{L_i}  
    + \alpha\sum_{j\in\mathcal{T}} f(a_j/A_j)
  \end{equation}
  where $L_i$ and $l_i$ are lengths of corresponding connections
  $i\in\mathcal{C}$ in the flattened and spherical retina
  respectively, $\alpha$ is a constant, $f$ is a penalty function to
  be defined below and $A_j$ and $a_j$ are signed areas of
  corresponding triangles $j\in\mathcal{T}$ in the flattened and
  spherical retina.  The signed area $a_i$ is positive for triangles in
  correct orientation, but negative for flipped triangles. The penalty
  function $f$ is a piecewise, smooth function that increases steeply
  with negative arguments:
  \begin{equation}
    \label{retistruct_plos:eq:1}
    f(x) = \left\{
        \begin{array}{ll}
          -(x - x_0/2) & x < 0 \\
          \frac{1}{2x_0}(x - x_0)^2 & 0 < x <x_0 \\
          0 & x \ge x_0
          \end{array} \right.
  \end{equation}
  The parameter $x_0$ is set at 0.1. There is thus no penalty unless
  triangles have been squashed to less than 10\% of their size in the
  flattened retina.  The parameter $\alpha$ is set to be large enough
  to prevent flipped triangles without causing numerical problems with
  the optimisation. The length of each edge $l_i$ is computed from the
  formula for the central angle between its vertices:
  \begin{equation}
    \label{retistruct_plos:eq:2}
    l(\phi_1, \lambda_1, \phi_2, \lambda_2) =
    R\cos\phi_1\cos\phi_2\cos(\lambda_1-\lambda_2) +
    \sin\phi_1\sin\phi_2   
  \end{equation}
  where $\phi_1$ and $\phi_2$ are the latitudes of the vertices and
  $\lambda_1$ and $\lambda_2)$ are the longitudes.  The derivatives of
  $E$ with respect to $\phi_i$ and $\lambda_i$ are computed and the
  BFGS quasi-Newton method implemented in the R optim function is used
  to minimise $E$.
\item The locations of data points and landmarks on the sphere are
  determined (Figure~\ref{fold-sphere:fig:method}F). To do this, for
  each data point the its barycentric coordinates within its containing
  triangle in the flat representation are determined.  The location of
  the point on the sphere is then found by projecting the point to the
  same set of barycentric coordinates in the corresponding triangle on
  the sphere. From this location in Cartesian 3D space, the spherical
  coordinates of the point are determined by projection of a line from
  the centre of the sphere through the point to the line's
  intersection with the sphere. This allows plotting of points in a
  polar representation. The procedure can be used in reverse to infer
  the locations of lines of latitude and longitude in the flat
  retina.
\item The Karcher mean of each set of points is determined
  (Figure~\ref{fold-sphere:fig:method}F). The Karcher mean of a set of
  points on the sphere \cite{Karc77riem,HeoSmal06form} is defined as
  the point $(\overline{\phi}, \overline{\lambda})$ that has a minimal
  sum of squared distances to the set of points $(\phi_i, \lambda_i)$:
  %% See also BergWerm06
  \begin{equation}
    \label{retistruct_plos:eq:3}
    (\overline{\phi}, \overline{\lambda}) = \mbox{arg min}_{(\phi,
      \lambda)} \sum_{i=1}^N l^2(\phi, \lambda, \phi_i, \lambda_i)
  \end{equation}
  where the function $l$ is defined in
  Equation~(\ref{retistruct_plos:eq:2}).
\end{enumerate}

The procedure of reconstructing a retina takes a few minutes on a
modern desktop computer.

% Do NOT remove this, even if you are not including acknowledgments
\section*{Acknowledgments}


%\section*{References}
% The bibtex filename
\newcommand{\myshortjournaltitles}{}
\bibliography{nmf_morph}
%\bibliography{template}

\section*{Figure Legends}
%\begin{figure}[!ht]
%\begin{center}
%%\includegraphics[width=4in]{figure_name.2.eps}
%\end{center}
%\caption{
%{\bf Bold the first sentence.}  Rest of figure 2  caption.  Caption 
%should be left justified, as specified by the options to the caption 
%package.
%}
%\label{Figure_label}
%\end{figure}

\begin{figure}[!ht]
  % Example. e.g. GM114-4/R-CONTRA (One subtear + gap)
  % GM184-5/R-CONTRA (One subtear, butter gap)
  % GM263-1/R-CONTRA (perfect!)
  \includegraphics{retistruct-method}
  
  \vspace*{-4.54in}

  \mbox{\hspace{2.27in}{
      \includegraphics[width=2.27in]{final-projection}
      \includegraphics[width=2.27in]{initial-projection}
    }}

  \vspace*{2.27in}

  \caption{\textbf{Overview of the method.} \textbf{(A)} The raw data:
    a retinal outline (black), three types of data point (red, green
    and yellow circles) and a landmark (blue line). \textbf{(B)}
    Retinal outline with nasal pole (N) and tears marked up. Each
    pair of red and orange lines indicate the vertices and apex of the
    five tears. Note that tear 2 is a child tear of tear 1. \textbf{(C)}
    The outline after triangulation (shown by grey lines) and
    stitching, indicated by blue lines between corresponding points
    on the tears. Green lines indicate connections between tear
    vertices.  \textbf{(D)} The initial projection of the triangulated
    and stitched outline onto a hemisphere. Tears are show in
    white. Below is a representation of lines of latitude and
    longitude on the flat outline. \textbf{(E)} The projection of the
    flat retina onto the sphere and the lines of latitude and
    longitude after optimisation of the mapping. \textbf{(F)} The data
    represented on a polar plot of the reconstructed retina. Mean
    locations of the different types of data points are indicated by
    filled diamonds. The nasal (N), dorsal (D), temporal (T) and
    ventral (V) poles are indicated. For reference, data is plotted on
    the flat representation below. }
  \label{fold-sphere:fig:method}
\end{figure}



\section*{Tables}
%\begin{table}[!ht]
%\caption{
%\bf{Table title}}
%\begin{tabular}{|c|c|c|}
%table information
%\end{tabular}
%\begin{flushleft}Table caption
%\end{flushleft}
%\label{tab:label}
% \end{table}

\end{document}


% LocalWords:  Sterratt Nedergaard MRC MacOS Retistruct BFGS optim Karcher arg
% LocalWords:  Acknowledgments nmf naso EphB dorso
