\documentclass{article}

\newcommand{\svninfo}{$ $Rev$ $, $ $Date$ $}
\pagestyle{myheadings}
\markboth{\svninfo}{\svninfo}

\usepackage[a4paper,left=1in,right=1in,top=1in,bottom=1in,head=1in]{geometry}

\usepackage[british]{babel}
\usepackage{tabularx}
\usepackage{graphicx}

\title{\textsc{Retistruct} manual}

\begin{document}

\maketitle
\thispagestyle{myheadings}

\section{Installation}
\label{manual:sec:installation}

\subsection{Install the necessary system packages}

\subsubsection{Fedora Linux }

As root,

\begin{verbatim}
yum install R-core
yum install R-devel
yum install gtk2
yum install gtk2-devel
yum install mesa-libGL-devel
yum install mesa-libGLU-devel
\end{verbatim}

\subsubsection{Ubuntu Linux}
At the command line, enter:

\begin{verbatim}
sudo apt-get install r-base-dev r-base-core r-cran-rgtk2 r-cran-cairodevice r-cran-rgl
\end{verbatim}

\subsection{Install the retistruct package}

\begin{enumerate}
\item Start \textsc{R}, in a directory containing the \texttt{install.R} and
   \texttt{retistruct\_0.x.x.tar.gz} files
 \item  Type:
\begin{verbatim}
   source("install.R")
\end{verbatim}
   The first time this runs, it should create a personal directory for
   R packages, and it will take a few minutes to install some required
   packages.
\end{enumerate}

\section{Running \textsc{Retistruct}}
\label{manual:sec:running}

To start the program, start \textsc{R}. At the \textsc{R} prompt type:

\begin{verbatim}
> library(retistructgui)
> retistruct()
\end{verbatim}
A window should appear.

\subsection{Opening the files for a retina}
\label{manual:sec:opening-files-retina}

At present \textsc{Retistruct} can read files in three formats.

\subsubsection{IDT format}
\label{retistruct-manual:sec:idt-format}

This is the format used in Ian Thompson's lab (see
Appendix~\ref{manual:sec:reading-data}). These files are contained in
a directory. To open the files corresponding to a retina, click on the
open file icon, and navigate to the directory containing the
\texttt{SYS} and \texttt{MAP} files. On opening this directory, the
retinal outline should appear in the \textsc{Retistruct} window.

\subsubsection{\textsc{ImageJ} ROI format}
\label{retistruct-manual:sec:ijroi-format}

This format allows you to load images of retinae whose outlines have
been marked up in \textsc{ImageJ}. To use this format:
\begin{enumerate}
\item Open up \textsc{ImageJ} (or FIJI).
\item Use \textbf{File$\rightarrow$Open} to open the image.
\item Use \textbf{Image$\rightarrow$Scale} to down sample so that the
  resolution is less than 1000x1000. (This is not crucial, but will
  speed up things later.)
\item Save the downsampled version of the image to the file name
  \texttt{image.png}
\item Use the Polygon Tool
  (\includegraphics[height=\baselineskip]{poly}) to mark the edge of
  the retina. According to the \textsc{ImageJ}
  manual\footnote{http://rsbweb.nih.gov/ij/docs/tools.html}: ``To
  create the selection, click repeatedly with the mouse to create line
  segments. When finished, click in the small box at the starting
  point (or double-click), and ImageJ automatically draws the last
  segment.

  The points that define a polygon selection can be moved or deleted,
  and new points can be added. To delete a point, click on it with the
  alt key down. To add a point, click on an existing point with the
  shift key down.''
\item Open the ROI manager by selecting
\textbf{Analyze$\rightarrow$Tools$\rightarrow$ROI Manager}.
\item Click on the \textbf{Add [t]} button.
\item Click on the \textbf{Save} button. In the \textbf{Save
selection\dots} box that appears, enter the file name
\texttt{outline.roi} and make sure this file is saved to the same
directory as the \texttt{image.png} file.
\item Open \textsc{Retistruct}.
\item Click on the \textbf{Open File} icon and select the directory
containing \texttt{image.png} and \texttt{outline.roi}.
\end{enumerate}

Optionally, the scale of the image can be specified by providing a
file \texttt{scale.csv} in the same directory as the image and ROI
files. This file should contain two lines, the first with the heading
\texttt{Scale} and the second with the length of the side of a pixel
in micrometres. For example:
\begin{verbatim}
"Scale"
1.5
\end{verbatim}

\subsubsection{CSV format}
\label{retistruct-manual:sec:csv-format}

This is the same as the \textsc{ImageJ ROI} format, except that the
outline is contained in the two columns of a file called
\texttt{outline.csv}.  Each column should have a heading, e.g.:
\begin{verbatim}
"X", "Y"
1,5
10,76,
...
\end{verbatim}


\subsection{The retinal display}
\label{manual:sec:retinal-display}

In the ``Show'' section at the bottom left of the screen there are
checkboxes that allow you to show various types of information:
\begin{description}
\item[Markup] Locations of tears and the dorsal or nasal pole
\item[Stitch] Locations of how the algorithm has stitched tears (only
  visible after the reconstruction step)
\item[Grid] Lines of latitude and longitude projected back onto the
  flattened retina (only visible after the reconstruction step)
\item[Datapoints] Locations of data points, such as the locations of
  beads of dye
\item[Landmarks] Landmarks such as the optic disc
\item[Strain] This shows information about how the retina has been
  reconstructed, after the reconstruction step has taken place.
\item[Preserve area] When this is selected, the polar plot displays an
  area-preserving projection
\item[Contours] Display Kernel Density Estimate contours of the data
  points. By default, contours at 5\%, 25\% and 50\% of the maximum
  density are shown. This can be changed by a command like this at the
  R prompt:
\begin{verbatim}
options(contour.levels=c(5,25,50,75,95))
\end{verbatim}
This command would cause the 5\%, 25\%, 50\%, 75\% and 95\% contour
lines to be displayed.
\end{description}

\subsection{Marking up the retina}
\label{manual:sec:opening-files-retina}

\begin{description}
\item[Add tear] To add a tear, click on this button, then click on
  three points in turn which define a tear. The order in which the
  points are added does not matter. Tears contained within a tear can
  be marked up, but tears cannot cross over one another.
\item[Move Point] To move one of the points defining a tear, click on
  this button, then click on the point which you desire to move, then
  click on the point to which it should be moved.
\item[Remove tear] To remove a tear, click on this button, then click
  on the apex of the tear (marked in cyan on the plot)
\item[Mark nasal] To mark the nasal pole, click on this button, then
  click on the point which is the nasal pole.  If the nasal or
  dorsal pole has already been marked, the marker is removed from
  the existing location. The nasal pole should not be in a tear. If
  the nasal tear is placed within a tear, no error is reported at this
  stage, but it will be reported later.
\item[Mark dorsal] As above, except for the dorsal pole.
\item[Mark OD] To mark the optic disc, click on the structure marked
  in orange which you think is the OD. Once clicked on, the structure
  should become blue.
\item[Phi0] This determines the latitude of the rim of the
  reconstructed hemisphere. It depends on the age of the animal.
\end{description}

\subsection{Metadata}
\label{retistruct-manual:sec:metadata}

\begin{description}
\item[Data/Flip DV] Flip the DV axis to compensate for microscope
  orientation. Affects display of retinae.
\item[Eye] Specify whether the eye is Right or Left.  Affects display
  of retinae.
\end{description}

\subsection{Saving the markup and metadata}
\label{manual:sec:saving-markup}

To save the markup, click on the ``Save'' button in the toolbar. This
saves various markup files to the directory containing the
data files. This saved data can be used to reconstruct the retina using
a batch process (Section~\ref{manual:sec:runn-batch-reconstr}).

\subsection{Reconstructing the retina}
\label{manual:sec:reconstr-retina}

To reconstruct the retina, click on the ``Reconstruct retina''
button. This causes a (lengthy) sequence of operations to be performed:
\begin{description}
\item[Stitching] Links between corresponding points on parts of the retinal
  outline  contained in tears are made.
\item[Triangulation] A triangular mesh is placed over the flattened retina
\item[Initial projection to sphere ] The mesh is projected roughly
  onto a sphere
\item[Optimisation] The locations of the mesh points on the hemisphere
  is adjusted so as to minimise a weighted sum of the squared
  differences between the lengths of links in the mesh on the
  hemisphere and on the flattened retina, whilst ensuring that as few
  triangles as possible are flipped.
\end{description}

At the end of the reconstruction process, a polar plot appears next to
the flattened retina. When ``Landmarks'' are shown, the location of
the cuts and tears in the polar coordinates can be seen.

When ``Strain'' is shown, the polar plot is replaced by a scatter plot of the
length of links in the reconstructed object versus the length on the
flattened object. The colours of the points indicate the degree of
expansion or compression from the flattened object to the
reconstructed object.

\subsection{Saving the reconstruction}
\label{manual:sec:saving-reconstr}

To save the markup, click on the ``Save'' button in the toolbar. This
saves various markup files to the directory containing the data files.

\subsection{Running a batch of reconstructions}
\label{manual:sec:runn-batch-reconstr}

The \textsc{Retistruct} library can be used to reconstruct a batch of
retinae which have been marked up. Suppose that the directory
\texttt{retinae} contains a directory tree in which there are data
directories containing \texttt{SYS} and \texttt{MAP} files and the
saved markup files. In order to perform the reconstructions, we create
a new directory \texttt{retinae/reconstructions}, and run the
following sequence of commands in R:
\begin{verbatim}
R
> library(retistruct)
> retistruct.batch(tldir='retinae', outputdir='retinae/reconstructions')
\end{verbatim}
This command will go through the \texttt{retinae} directory, looking
for valid data directories. If it finds one, it sets about trying to
reconstruct the retina. As it reconstructing each retina, it writes to
log file in \texttt{retinae/reconstructions}. Once the reconstruction
is complete, it saves a number of plots in this directory in PDF
format. It also adds a line to a summary log file in
\texttt{retinae/reconstructions} called
\texttt{retistruct-batch.csv}. This file contains a number of columns:
\begin{description}
\item[\texttt{Dataset}] The directory of the data set
\item[\texttt{Return}] The return value from the process
\item[\texttt{Result}] A summary of the result, including if any
  errors were returned
\item[\texttt{E}] The total error  of the optimised reconstruction
\item[\texttt{El}] The error due to purely to the lengths of links in
  the optimised reconstruction
\item[\texttt{nflip}] The number of flipped triangles
\item[\texttt{EOD}] The distance of the Optic Disc from the inferred
  centre of the retina, in degrees. If the OD has not been marked up,
  this is \texttt{NA}.
\end{description}

\subsection{Exporting reconstruction data to \textsc{Matlab}}
\label{retistruct-manual:sec:export-reconstr-data}

To export the reconstruction data in a directory hierarchy in which
\texttt{retistruct.batch()} has been run, run the following sequence
of commands in R:
\begin{verbatim}
R
> library(retistruct)
> retistruct.batch.export.matlab(tldir='retinae')
\end{verbatim}
This creates a file called \texttt{r.mat} in each directory in which
there has been a successful reconstruction. To import this data into
\textsc{Matlab}, cd into that directory, and type:
\begin{verbatim}
clear
load r.mat
\end{verbatim}
This puts a number of variables into the workspace, as shown in
Table~\ref{tab:matlab-export}.

To produce a polar plot of data points, try the following code:
\begin{verbatim}
polar(Dss.green(:,2), Dss.green(:,1)*180/pi+90, '.g')
hold on
polar(Dss.red(:,2),   Dss.red(:,1)*180/pi  +90, '.r')
hold off
\end{verbatim}
The radial axis indicates the latitude in degrees measured from the
retinal pole.

In the \texttt{matlab} subdirectory of the distribution, there are
some scripts to produce polar polar plots, including the locations of
tears and landmarks. To create PDF plots of all the retinae in a
directory, try:
\begin{verbatim}
makefigures('retinae', 'output_directory')
\end{verbatim}

There are also some embryonic scripts to create polar plots:
\texttt{plot\_datapoints\_polararea.m} and \texttt{polararea.m}.

\begin{table}
  \begin{tabularx}{\linewidth}{lX}
    \hline \texttt{phi0} & The latitude of the rim, expressed in
    radians
    \\
    \texttt{Dss.green} & Locations of green-labelled cell bodies in
    spherical coordinates. The first column contains the latitude of
    each point, measured in radians. The second column contains the
    longitude of each point, measured in radians. \\
    \texttt{Dss.red} & Locations of red-labelled cell
    bodies. Columns have same meaning as \texttt{Dss.green}. \\
    \texttt{DssMean.green} & Location of Karcher mean of
    green-labelled cell bodies in spherical coordinates. The first
    column contains the latitude of each point, measured in
    radians. The second column contains the
    longitude of each point, measured in radians. \\
    \texttt{DssMean.red} & Location of Karcher mean of red-labelled
    cell bodies. Columns have same meaning as \texttt{DssMean.green}. \\
    \texttt{Tss} & A structure in which each element contains
    spherical coordinates (in the same latitude-longitude format as
    above) of a tear. \\
    \texttt{Sss} & A structure in which each element contains
    spherical coordinates (in the same latitude-longitude format as
    above) of a landmark. \\
    \texttt{KDE} & An object containing information about Kernel
    Density Estimates of the locations of cell bodies. For example,
    elements such as \texttt{KDE.green\_contours5} contain the 5\%
    contours of the green cell bodies. To customise the contours, see
    the instructions in Section~\ref{manual:sec:retinal-display}. The
    full density information is contained in
    \texttt{KDE.green\_g\_xs}, \texttt{KDE.green\_g\_ys}, and
    \texttt{KDE.green\_g\_f}. This can be plotted in MATLAB using the
    command \texttt{contour(KDE.green\_g\_xs, KDE.green\_g\_ys,
      KDE.green\_g\_f)}. \\
    \hline
  \end{tabularx}
  \caption{Variables exported in the \texttt{r.mat} file.}
  \label{tab:matlab-export}
\end{table}

\appendix

\section{Data format}
\label{manual:sec:reading-data}

\begin{table}
  \begin{tabular}{ll}
    \hline
    \multicolumn{2}{c}{\textbf{FOR EACH BOUNDARY}} \\
    \hline
    \texttt{MAPNUM}   & id number of boundary \\  
    \texttt{MINLAT}   & min latitude      \\
    \texttt{MAXLAT}   & max latitude      \\
    \texttt{MINLON}   & min longitude     \\
    \texttt{MAXLON}   & max longitude     \\
    \texttt{LABLAT}   & latitude of label \\
    \texttt{LABLON}   & longitude of label\\
    \hline
    \multicolumn{2}{c}{\textbf{FOR EACH CELL}} \\
    \hline
    \texttt{XRED}     & $x$-coordinate if cell labelled red but not doubly\\
    \texttt{YRED}     & $y$-coordinate if cell labelled red but not doubly\\
    \texttt{XGREEN}   & $x$-coordinate if cell labelled green but not doubly\\
    \texttt{YGREEN}   & $y$-coordinate if cell labelled green but not doubly\\
    \texttt{XDOUBLE}  & $x$-coordinate if cell labelled doubly\\ 
    \texttt{YDOUBLE}  & $y$-coordinate if cell labelled doubly\\
    \texttt{XGRID}    & sample box cell is in \\
    \texttt{YGRID}    & sample box cell is in \\
    \texttt{PERIM}    & perimeter of cell \\
    \texttt{AREA}     & area of cell \\
    \hline
    \multicolumn{2}{c}{\textbf{ONE PER GRID BOX}} \\
    \hline
    \texttt{GRIDX}    & grid location of centre of sample box \\
    \texttt{GRIDY}    & grid location of centre of sample box \\
    \texttt{XGRIDCOO} & $x$-coordinate of centre of sample box \\
    \texttt{YGRIDCOO} & $y$-coordinate of centre of sample box \\
    \texttt{BOXSIZEX} & size (half width) of sample box in $x$-direction \\
    \texttt{BOXSIZEY} & size (half width) of sample box in $y$-direction \\
    \texttt{COMPLETE} & whether counting of sample has been completed\\
    \texttt{TOTALCEL} & total number of cells in this box\\
    \texttt{TOTALRED} & total number of red-only cells in this box\\
    \texttt{TOTALGRE} & total number of green-only cells in this box\\
    \texttt{TOTALDOU} & total number of double cells in this box\\
    \texttt{MEANPERI} & average perimeter of all cells \\
    \texttt{MEANAREA} & average area of all cells \\
  \end{tabular}
  \caption{Column headings of the \texttt{SYS.SYS} file.}
  \label{tab:data-format}
\end{table}

The data for each retina is stored in a separate directory. Within
each directory there are two files:
\begin{description}
\item[\texttt{SYS.SYS}] A table in SYSTAT format containing the
  coordinates of the red, green and doubly labelled cell bodies, and
  counts of labelled cell bodies within each grid box. The column
  headings shown in Table~\ref{tab:data-format}.  Each row of the
  table contains information only on a subset of the data, e.g.\ the
  coordinates of a red-labelled cell.
\item[\texttt{ALU.MAP}] A text file containing the coordinates of the
  map outline. The file comprises a number of sections, each starting
  with a single number, which is the number of lines to read in the
  next section. These lines have two numbers each, the $x$ and $y$
  coordinates of a vertex of the map outline.
\end{description}

% \section{Reading in and displaying data}
% \label{manual:sec:datafile-utils}

% All code is to be found in the \texttt{trunk/src} directory. The R
% program should be started from this directory in the following examples.

% To read in data use the functions in \texttt{datafile-utils.R}. Here
% is code to read in the data from a directory containing the
% \texttt{SYS.SYS} and \texttt{ALU.MAP} files, as detailed above:
% \begin{verbatim}
% source("datafile-utils.R")
% sys <- read.sys("/data/path/gm257-1-P8-C57BL6/")
% map <- read.map("/data/path/gm257-1-P8-C57BL6/")
% plot.sys.map(sys, map)
% \end{verbatim}


\end{document}

%%% Local Variables: 
%%% TeX-PDF-mode: t
%%% End: 

% LocalWords:  MAPNUM MINLAT MAXLAT MINLON MAXLON LABLAT LABLON XRED YRED XGRID
% LocalWords:  XGREEN YGREEN XDOUBLE labeled YGRID PERIM GRIDX GRIDY XGRIDCOO
% LocalWords:  YGRIDCOO BOXSIZEX BOXSIZEY TOTALCEL TOTALRED TOTALGRE TOTALDOU
% LocalWords:  MEANPERI MEANAREA SYS SYSTAT ALU src datafile utils myheadings
% LocalWords:  Ubuntu retistruct Datapoints PDF csv Dataset nflip EOD YDOUBLE
% LocalWords:  Matlab cd matlab lX Dss Tss Sss IDT ImageJ png Analyze roi DV xs
% LocalWords:  Metadata metadata datapoints polararea DssMean KDE ys
